# 项目交接文档 (Handover Documentation)

## 1. 项目概况
本项目是一个基于中国象棋规则，融合 Roguelike 卡牌构建元素的在线对战游戏。玩家在传统象棋的回合制对弈中，通过抽取和使用功能各异的锦囊卡牌（召唤、装备、行动、规则等）来改变战局。项目包含完整的用户注册/登录系统、大厅/房间管理机制以及核心游戏引擎。

---

## 2. 可用资源

### 2.1 服务器信息
- **IP 地址**: `120.26.212.80`
- **SSH 端口**: `22`
- **Web 服务端口**: `80`
- **游戏访问地址**: [http://120.26.212.80](http://120.26.212.80)

### 2.2 账号凭证 (SSH & 管理)
- **用户名**: `root`
- **密码**: `Game2026`

### 2.3 后端管理
后端服务使用 `pm2` 进行进程管理。
- **查看状态**: `pm2 list`
- **查看日志**: `pm2 logs game`
- **重启服务**: `pm2 restart game`
- **项目部署路径**: `/var/www/game`

---

## 3. 游戏玩法与规则 (已更新)

### 基础规则
- **获胜条件**: 吃掉对方的“将/帅”。
- **基本走发**: 遵循中国象棋标准规则。
- **思考时间**: **每回合 60 秒**。超时后**自动跳过当前回合**（移交控制权），不直接判负。

### 卡牌系统
- **锦囊（手牌）**: 玩家每回合开始时进行“选牌”（3选1）。若手牌已满（3张），则**跳过选牌阶段**。
- **稀有度**: 分为白银 (40%)、黄金 (40%)、彩色 (Prismatic, 20%)。若一方选了某种稀有度，下一回合对手选牌时出现的卡牌稀有度将与之一致（同步机制）。
- **主要卡牌类型**:
  - **速攻**: 仅在当前回合生效的卡牌。
  - **召唤 (Summon)**: 在棋盘放置中立或己方单位（如路障、援军）。*修复了中立单位显示崩溃问题。*
  - **装备 (Equip)**: 强化棋子（如洋装-兵升车、自爆装置）。
  - **行动 (Action)**: 发动后会跳过当前回合棋子行动阶段的卡牌。
  - **永续 (Rule/环境卡)**: 改变全局规则。**场上同一时间仅生效一张环境卡**，后发动的环境卡会顶替旧卡。
  - **陷阱**: 使用后隐蔽生效，在特定条件触发时会对双方显示弹窗提示（持续2秒）。
47: 
48: ### 特殊规则补充
49: - **召唤物上限**: 场上最多同时存在 **2 个** 召唤物。当生成第 3 个召唤物时，最早生成的那个会被移除 (FIFO 原则)。
50: - **炮架自毁**: 当“炮”利用**召唤物**作为炮架进行吃子时，该“炮”在吃子后会**同归于尽**（连同被吃子一起移除）。若拥有“耸肩”状态可免疫。

---


### ✨ 数据与日志 (Data & Logging)
- **数据库架构**: MySQL，包含 `GameRecord` (对局)、`UserActionLog` (行为)、`PointsTransaction` (点数)、`ErrorLog` (错误) 等模型。
- **日志系统**:
  - **对局日志**: 每局游戏生成详细的 JSON 日志文件，存储在服务器 `/var/www/game/logs/games/` 目录下。包含完整的初始状态、时间线和每一步操作。
  - **错误监控**: 服务器报错自动记录到数据库 `server/logs/errors/` 和数据库表。
  - **查询工具**: 代码中包含 `scripts/check-logs.js` 等工具便于运维查询。

---

## 4. 项目结构与文件说明

| 目录/文件 | 说明 |
| :--- | :--- |
| **`src/`** | **前端源码 (React + Vite)** |
| `src/game/engine.js` | **核心引擎**：处理移动验证、卡牌效果解析、回合流转、状态管理。 |
| `src/game/cards.js` | 卡牌生成与随机逻辑（含 Seeded RNG 同步）。 |
| `src/game/cardDefs.js` | 33种卡牌的属性定义（ID、名称、效果描述）。 |
| `src/components/` | UI 组件 (GameArena, Board, Card, Lobby, Toast 等)。 |
| **`server/`** | **后端源码 (Node.js + Express + Socket.IO)** |
| `server/index.js` | 入口文件，HTTP 服务启动。 |
| `server/socket.js` | Socket.IO 事件处理 (房间管理、游戏同步、日志记录)。 |
| `server/models/` | **数据库模型** (User, GameRecord, Card, PointsTransaction, etc.)。 |
| `server/services/` | **服务层** (LoggerService - 日志服务)。 |
| `server/managers/` | 业务逻辑层 (RoomManager)。 |
| **`scripts/`** | **自动化脚本** |
| `scripts/auto-deploy.js` | 一键部署脚本 (打包 -> 上传 -> 重启)。 |
| `scripts/check-logs.js` | 远程日志查询工具。 |
| `config/` | 数据库配置文件。 |

---

## 5. 任务完成情况与优化

### ✨ 近期优化 (Recent Optimizations)
*(此处列出最近进行的不属于Bug修复的功能性改进)*
1.  **全新状态面板 (Dashboard Refactor)**:
    - 移除了冗长的纯文本历史记录，改为更加直观的顶部状态栏。
    - 动态显示当前阶段提示（如“请挑选你的锦囊”、“对手正在思考”）。
    - 集成倒计时显示与陷阱触发的高亮提示。
2.  **防崩溃机制 (Anti-Crash)**:
    - 引入 `ErrorBoundary` 全局组件，防止渲染错误导致白屏。
    - 引入 `ToastProvider` 替代原生 `alert`，提供非阻塞式的错误与状态通知。
    - 对核心交互函数添加 `try-catch` 保护，提升游戏稳定性。
3.  **视觉与交互体验**:
    - **棋盘翻转修正**: 修复了黑方视角下，选中或高亮棋子文字倒置的问题。
    - **结算界面升级**: 重新设计了游戏结束弹窗，尺寸更大，视觉效果更强，明确区分胜利与败北。
4.  **游戏节奏调整**:
    - 缩短回合时间为 60秒，并添加了最后 10 秒的倒计时红色警示。
86: 5.  **0.2.0 更新优化**:
87:     - **性能优化**: 彻底优化了棋盘渲染逻辑 (`useMemo` + `useCallback`)，消除计时器引起的不必要重绘。
88:     - **体验优化**: 增加了“将军”时的视觉提示特效；将卡牌尺寸扩大 40% 提高可读性。
89:     - **代码重构**: 提取内联样式至 CSS 文件，修复了数个核心逻辑 Bug (P0)。

### ✅ 已修复 Bug (Fixed Bugs)
- [x] **召唤卡牌崩溃**: 修复了召唤中立单位（如大奖、路障）时因缺少字符映射导致的程序崩溃。
- [x] **双败显示**: 修复了游戏结束后双方均显示“败北”的逻辑错误。
- [x] **房间列表同步**: 修复了服务器在创建房间时未正确跟踪 ID，导致断线后产生幽灵房间的问题。
- [x] **手牌逻辑**: 实现了手牌上限(3张)检测与满手牌跳过抽卡逻辑。


## 6. 部署说明
代码已包含自动化部署脚本。在项目根目录下运行以下命令即可将最新更改发布到测试服务器：
```bash
npm run deploy
```
