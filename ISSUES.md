# 问题清单 (Issue Tracker)

**当前版本**: `v0.2.6`  
**更新日期**: 2026-01-20  
**维护者**: Development Team

---

## 📊 统计概览

| 类别 | 总数 | 已完成 | 进行中 | 待处理 |
|------|------|--------|--------|--------|
| 🔴 严重 Bug | 5 | 5 | 0 | 0 |
| 🟠 中等问题 | 5 | 4 | 0 | 1 |
| 🟡 次要问题 | 4 | 1 | 0 | 3 |
| 🔵 体验优化 | 4 | 3 | 0 | 1 |
| 🛠️ 最佳实践 | 4 | 1 | 0 | 3 |

---

## 🔴 严重 Bug (P0 - Critical)

### BUG-001: 超时逻辑使用错误的 state
- **文件**: `src/game/engine.js` Line 976
- **描述**: `TICK_TIMER` 中超时时调用 `switchTurnLogic(state)` 而非 `switchTurnLogic(newState)`，导致超时日志丢失
- **影响**: 游戏逻辑错误，日志记录不完整
- **状态**: ✅ 已修复 (v0.1.1)

### BUG-002: 召唤物被吃时未从追踪列表移除
- **文件**: `src/game/engine.js` Line 797-798
- **描述**: 当召唤物被吃掉时，`summonedPieces` 数组未同步更新，导致召唤物上限计算错误
- **影响**: 召唤物上限 (2个) 机制失效
- **状态**: ✅ 已修复 (v0.1.1)

### BUG-003: 洪水效果对中立召唤物崩溃
- **文件**: `src/game/engine.js` Line 708-710
- **描述**: 洪水消灭河道棋子时，尝试将中立棋子 push 到 `players['neutral'].dead`，但 `players` 无 `neutral` 键
- **影响**: 触发洪水时游戏崩溃
- **状态**: ✅ 已修复 (v0.1.1)

### BUG-004: Jackpot 吃子后卡牌数量计算错误
- **文件**: `src/game/engine.js` Line 804-805
- **描述**: `cardsToGet = Math.min(currentHandSize, 3 - currentHandSize)` 当手牌为 0 时结果为 0
- **影响**: 空手牌时吃大奖得不到任何卡牌
- **状态**: ✅ 已修复 (v0.1.1)

### BUG-005: 重复的代码行
- **文件**: `src/game/engine.js` Line 574-576
- **描述**: 永续卡清理逻辑重复执行两次，同一行代码复制粘贴
- **影响**: 代码冗余，无功能性问题但需清理
- **状态**: ✅ 已修复 (v0.1.1)

---

## 🟠 中等问题 (P1 - Medium)

### BUG-006: Lobby 在 Socket 未连接时发送请求
- **文件**: `src/components/Lobby.jsx` Line 12
- **描述**: 组件挂载时直接 `socket.emit('get_rooms')`，但此时 socket 可能未连接
- **影响**: 首次加载时房间列表可能为空
- **状态**: ✅ 已修复 (v0.1.1)

### BUG-007: ACTION_SUS_TRADE (可疑交易) 永远无效
- **文件**: `src/game/engine.js` Line 526
- **描述**: 检查 `lastMovedPieceType` 属性，但该属性从未在任何地方设置
- **影响**: 「可疑交易」卡牌完全无法生效
- **状态**: ✅ 已修复 (v0.1.1) - 在移动棋子后添加了 lastMovedPieceType 记录

### BUG-008: 状态浅拷贝导致不可变性违反
- **文件**: `src/game/engine.js` 多处
- **描述**: Reducer 使用 `{ ...state }` 浅拷贝，后续直接 push/filter 修改数组引用
- **影响**: 可能导致 React 状态不一致和渲染问题
- **状态**: ⚠️ 部分修复 / 需持续关注
- **备注**: 关键路径（如移动、吃子）已通过 filter/push 创建新数组引用，但对象属性变异仍存在。彻底修复需要引入 immer 或大规模重构，暂缓。

### BUG-009: handleSquareClick 中混用 dispatch 和 handleGameAction
- **文件**: `src/components/GameArena.jsx` Line 217
- **描述**: 选择棋子时直接调用 `dispatch` 而非 `handleGameAction`
- **影响**: 在线模式下选择棋子不会同步给对手（虽然当前无需同步，但不一致）
- **状态**: ✅ 已修复 (v0.1.1)

### BUG-010: Socket CORS 配置过于宽松
- **文件**: `server/index.js` Line 51-56
- **描述**: `origin: "*"` 允许任意来源连接
- **影响**: 生产环境安全隐患
- **状态**: ✅ 已修复 (v0.1.1) - 生产环境限制为特定域名

---

## 🟡 次要问题 (P2 - Minor)

### ISSUE-011: CSS 内联样式过多
- **文件**: `src/components/GameArena.jsx` Line 376 等
- **描述**: 大量样式写在 JSX 的 style 属性中
- **影响**: 代码可维护性差
- **状态**: ✅ 已修复 (v0.1.2)
- **备注**: 样式已提取至 `src/components/GameArena.css`

### ISSUE-012: Board.jsx 渲染未缓存
- **文件**: `src/components/Board.jsx` Line 101-165
- **描述**: `renderCells()` 每次渲染都重新计算 90 个格子
- **影响**: 性能问题，可能卡顿
- **状态**: ✅ 已修复 (v0.1.2)
- **备注**: `renderCells` 已使用 `useMemo` 缓存，`handleSquareClick` 已使用 `useCallback` 和 `useRef` 避免计时器触发重绘

### ISSUE-013: Magic Numbers 未抽取为常量
- **文件**: `src/game/engine.js` 多处
- **描述**: `3` (手牌上限)、`60` (回合时间)、`2` (召唤物上限) 等硬编码
- **影响**: 代码可读性和可配置性差
- **状态**: ✅ 已修复 (v0.1.1) - 新增 GAME_CONFIG 常量

### ISSUE-014: 缺少 ErrorBoundary 实际应用
- **文件**: `src/App.jsx`
- **描述**: HANDOVER.md 提到引入了 ErrorBoundary，但实际代码中未看到包裹
- **影响**: 渲染错误可能导致白屏
- **状态**: ✅ 已修复 (v0.1.2)
- **备注**: `src/main.jsx` 中已包含全局 `ErrorBoundary`

---

## 🔵 玩家体验优化 (UX)

### UX-001: 缺少将军提示
- **描述**: 对方将军时没有明显的视觉/音效提示
- **建议**: 添加红色边框闪烁 + 声音
- **优先级**: 中
- **状态**: ✅ 已实现 (v0.1.1) - 添加将军检测和视觉闪烁效果

### UX-002: 回合倒计时缺乏紧迫感
- **描述**: 最后几秒只有数字变化，无警告
- **建议**: 最后 10 秒变红色 + 闪烁 + 滴答声
- **优先级**: 中
- **状态**: ✅ 已实现 (v0.1.1) - 最后10秒红色闪烁效果

### UX-003: 本地模式手牌需隐藏
- **描述**: 热座模式下只显示当前回合玩家的手牌
- **建议**: 非当前回合玩家的手牌默认不可见
- **优先级**: 中
- **状态**: ✅ 已确认 (v0.1.1) - 设计已符合要求，只显示当前回合玩家手牌

### UX-004: 卡牌尺寸过小
- **描述**: 卡牌太小，文字显示不完整
- **建议**: 卡牌尺寸扩大 40%
- **优先级**: 高
- **状态**: ✅ 已实现 (v0.1.1) - 尺寸从 150x200 扩大至 210x280

### UX-005: 缺少棋谱/历史回放 (后续版本)
- **描述**: 游戏结束后无法回顾对局
- **建议**: 保存对局日志，支持步进回放
- **优先级**: 低
- **状态**: 📅 后续版本实现

---

## 🛠️ 最佳实践改进

### TECH-001: 缺少 TypeScript
- **描述**: 纯 JavaScript 项目，无类型检查
- **建议**: 逐步迁移至 TypeScript
- **优先级**: 低
- **状态**: ⏳ 待评估

### TECH-002: 缺少单元测试
- **描述**: 核心引擎 900+ 行代码无测试覆盖
- **建议**: 添加 Jest 测试，覆盖 engine.js 核心逻辑
- **优先级**: 中
- **状态**: ⏳ 待实现

### TECH-003: 缺少后端游戏状态验证
- **描述**: 游戏逻辑完全在客户端，后端仅转发
- **风险**: 恶意玩家可发送伪造动作
- **建议**: 后端实现核心规则校验
- **优先级**: 高 (安全相关)
- **状态**: ⏳ 待评估

### TECH-004: 常量文件需要完善
- **文件**: `src/game/constants.js`
- **描述**: 部分常量散落各处未集中管理
- **状态**: ✅ 已优化 (v0.1.1) - 新增 GAME_CONFIG 统一管理

---

## 📝 版本历史

### v0.2.6 (2026-01-20)
- 🐛 修复顶号机制 (使用延迟断开避免竞态条件)
- 🐛 增加房间列表和匹配系统的调试日志

### v0.2.5 (2026-01-20)
- 🔒 新增安全机制：单点登录 (顶号) 机制
- ⌛ 新增游戏规则：断线超时判负机制 (对手掉线且超时直接获胜)

### v0.2.4 (2026-01-20)
- 🔴 修复匹配系统后端逻辑 (变量提升与重复代码问题)
- 🔴 修复大厅 (Lobby) 界面渲染错误

### v0.2.3 (2026-01-20)
- ✨ 新增功能：快速匹配系统 (先到先得队列)
- 🔵 界面优化：大厅新增匹配入口面板

### v0.2.2 (2026-01-20)
- 🟡 修复将军检测逻辑 (增加 ignoreTurn 支持)
- 🔵 界面美化：添加象棋木纹材质，优化状态栏布局 (合并永续卡显示)

### v0.2.1 (2026-01-20)
- 🔴 修复严重 Crash Bug (renderCells is not defined)

### v0.2.0 (2026-01-20)
- 🔴 修复 1 个严重 Bug (BUG-008 部分优化)
- 🟡 修复 3 个次要问题 (ISSUE-011, ISSUE-012, ISSUE-014)
- 代码结构优化：`GameArena` 样式分离

### v0.1.1 (2026-01-20)
- 🔴 修复 5 个严重 Bug (BUG-001 至 BUG-005)
- 🟠 修复 4 个中等问题 (BUG-006, BUG-007, BUG-009, BUG-010)
- 🟡 优化 1 个次要问题 (ISSUE-013 常量抽取)
- 🔵 实现 4 个体验优化 (UX-001 至 UX-004)
- 🛠️ 完善 1 个最佳实践 (TECH-004)

### v0.1.0 (2026-01-20)
- 初始版本
- 完成核心游戏功能
- 完成用户系统
- 完成房间匹配系统
- 记录 24 个已知问题待修复

---

## 🔗 相关文档

- [交接文档 (HANDOVER.md)](./HANDOVER.md)
- [部署说明 (DEPLOYMENT.md)](./DEPLOYMENT.md)
- [自动部署 (AUTO_DEPLOY.md)](./AUTO_DEPLOY.md)
